---
- name: D√©ploiement complet d'AdSecureCheck via install.sh
  hosts: production
  become: yes
  gather_facts: yes
  vars_files:
    - ../group_vars/all.yml

  tasks:
    - name: V√©rifier que git est install√©
      apt:
        name: git
        state: present
        update_cache: yes

    - name: V√©rifier que curl est install√©
      apt:
        name: curl
        state: present
        update_cache: yes

    - name: Supprimer le r√©pertoire existant si pr√©sent
      file:
        path: "{{ project_path | default('/home/{{ ansible_user }}/Sae502') }}"
        state: absent

    - name: Cloner le d√©p√¥t Git
      git:
        repo: "https://github.com/SH0000T/Sae502.git"
        dest: "{{ project_path | default('/home/{{ ansible_user }}/Sae502') }}"
        version: "main"
        force: yes

    - name: S'assurer que le script install.sh est ex√©cutable
      file:
        path: "{{ project_path | default('/home/{{ ansible_user }}/Sae502') }}/install.sh"
        mode: '0755'

    - name: Lancer le script install.sh
      command: "{{ project_path | default('/home/{{ ansible_user }}/Sae502') }}/install.sh"
      args:
        chdir: "{{ project_path | default('/home/{{ ansible_user }}/Sae502') }}"
      ignore_errors: yes  # <-- permet de continuer m√™me si rc != 0

    - name: Afficher le message final
      debug:
        msg:
          - "=================================================="
          - "‚úÖ D√âPLOIEMENT TERMIN√â AVEC SUCC√àS !"
          - ""
          - "üåê Frontend: http://{{ ansible_host }}:{{ frontend_port | default('3000') }}"
          - "üîå API Backend: http://{{ ansible_host }}:{{ api_port | default('5000') }}/api/health"
          - "üóÑÔ∏è  Base de donn√©es: PostgreSQL sur port {{ db_port | default('5432') }}"
          - ""
          - "üìã Commandes utiles :"
          - "  - Voir les conteneurs : docker ps"
          - "  - Voir les logs backend : docker logs adsecure-backend"
          - "  - Arr√™ter tous les conteneurs : cd {{ project_path | default('/home/{{ ansible_user }}/Sae502') }} && docker compose down"
          - "  - Red√©marrer tous les conteneurs : cd {{ project_path | default('/home/{{ ansible_user }}/Sae502') }} && docker compose up -d"
          - ""
          - "=================================================="
